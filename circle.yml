machine:
  node:
    version: v8.2.0
  environment:
    JVM_OPTS: "-Xms512m -Xmx1024m"
dependencies:
  override:
    - lein deps
    - npm install -g karma-cli
    - npm install
test:
  override:
    # Cljsjs - browser
    - rm -rf node_modules/react node_modules/react-dom node_modules/create-react-class node_modules/@cljs-oss
    - lein with-profile test do clean, doo chrome-headless client once
    - test -f out/cljsjs/react/development/react.inc.js

    # Cljsjs - browser - React 16
    - lein with-profile react-16,test do clean, doo chrome-headless client once
    - test -f out/cljsjs/react/development/react.inc.js

    # Cljsjs - Production build - Browser
    - lein with-profile prod-test do clean, doo chrome-headless client once

    # Node Modules - Browser
    - npm install
    - lein with-profile test do clean, doo chrome-headless client once
    - test -f out/node_modules/react/react.js

    # Node Modules - Node Target
    - lein with-profile node-test do clean, doo node client once
    - test ! -f out/node_modules/react/index.js
    - grep "reagent.impl.template.node\$module\$react = require('react')" out/reagent/impl/template.js

    # Node Modules - Browser - React 16
    - npm install react@16.0.0 react-dom@16.0.0
    - lein with-profile test do clean, doo chrome-headless client once
    - test -f out/node_modules/react/index.js
